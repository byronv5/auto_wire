### 原理图自动生成工具 V21.0（智能布局增强版）

一个前端纯静态的原理图自动布局与布线原型工具：
- **输入**：器件库（SVG 符号，含引脚元数据）与网表（JSON 或 Protel NET 文本）
- **输出**：自动布局、自动布线后的原理图

---

### 快速开始
- 直接用浏览器打开项目根目录下的 `自动布线工具V1.13.8.html`
- 左上角按顺序操作：
  1) 导入 SVG 库（支持多选）
  2) 导入网表
  3) 点击「自动布局 + 布线」

提示：右键拖拽平移画布，滚轮缩放；顶部工具栏也有放大、缩小、适应。

---

### 支持的网表格式
- JSON：`{ components: [...], nets: [...] }` 或 `{ plan: { components: [...], nets: [...] } }`
- Protel NET 文本：以 `[]` 块定义器件、`()` 块定义网络，形如 `U1-PA0` 的 `ref-pin` 节点

---

### 核心流程（从入口到结果）
入口 `src/main.js` 中 `runFullLayout()` 调用链：
1) `buildInstances()`：根据网表构建实例，匹配或占位符号并渲染
2) `createFunctionalClusters()`：按网络关联度做功能聚类
3) `placeAndRouteClusters()`：簇级宏观布局（中心优先、同心锚点放置）并在簇内占位
4) `assignPrimaryICs()`：为被动件指定"主关联 IC"
5) `placePassivesAroundICs()`：按引脚侧边在 IC 四周做"腰带式"贴芯摆放
6) `autoOrient()`：依据引脚连接方向自动选择器件朝向
7) `resolveClusterOverlaps()`：簇内器件微调消碰
8) `routeAllNets()`：A* 栅格路由，含电源符号就地短接、软硬障碍避让、结点采样建树

---

### 主要模块概览（按职责单一原则划分）
- `src/state.js`：全局常量、运行时状态 `App`、参数 `Params`、UI 工具、提示 `toast`
- `src/plan.js`：网表导入、解析（JSON/Protel NET）、校验、侧栏展示
- `src/lib.js`：SVG 符号库加载与候选检索（含别名与归一化匹配）
- `src/symbols.js`：器件实例化、符号选择/占位、渲染与拖拽
- `src/cluster.js`：功能聚类、簇图构建、簇级放置、簇内初始占位
- `src/cluster_refine.js`：被动件主 IC 归属、四侧"腰带"贴芯、簇内消碰
- `src/orient.js`：基于邻接中心与引脚侧边的自动朝向
- `src/routing/index.js`：A* 网线布线（硬/软障碍索引、逃逸、锚点采样、连接建树、功率符号/标签）
- `src/geometry.js`：尺寸/坐标/碰撞/路径几何工具集
- `src/view.js`：视图移动/缩放、按钮联动
- `style.css`：UI 与 SVG 样式

---

### 关键算法要点
- **功能聚类**：按网络权重（排除电源网）建立器件邻接图；IC 作为种子，聚合被动与未归属器件；生成簇间加权图
- **簇级布局**：中心簇（外部权重 + IC 评分）先放置，环形锚点上择优放置相邻簇，避免簇间重叠（边界与间隙）
- **贴芯摆放**：被动按与 IC 的连接引脚落在哪个侧边分配到 `left/right/top/bottom` 队列；过多时做侧边再分配；按步距在簇内找位
- **自动朝向**：在候选角（被动 0/90/180/270，IC 0/180）里最小化"引脚侧边与邻接中心的方向不一致"代价
- **A* 布线**：
  - 栅格步进 `GRID`，启发式为曼哈顿距离
  - 硬障碍：器件外扩矩形；软障碍：已布导线外扩矩形（同网惩罚更低）
  - 逃逸：先从引脚按侧边逃逸至自由点；锚点采样构建树，依次连接剩余引脚
  - 电源网：就地符号短接（VCC 三角、GND 平行线），其他失败的网使用文字标签

---

### 运行与构建
- 根目录执行:`serve -l 5173`，浏览器访问`http://localhost:5173`
- 推荐现代浏览器（Chrome/Edge）；本地文件读取用于加载库与网表

---

### 目录结构
```
auto_wire/
  ├─ src/
  │  ├─ cluster.js
  │  ├─ cluster_refine.js
  │  ├─ geometry.js
  │  ├─ lib.js
  │  ├─ main.js
  │  ├─ orient.js
  │  ├─ plan.js
  │  ├─ routing/
  │  │  └─ index.js
  │  ├─ state.js
  │  ├─ symbols.js
  │  └─ view.js
  ├─ style.css
  └─ 自动布线工具V1.13.8.html
```

---

### 已知限制与后续方向
- 单层曼哈顿路由，暂不区分多层/过孔
- 复杂网表下可能出现未完全布通的网络，将以文字标签提示
- SVG 库质量影响很大：建议完善元数据、统一坐标与引脚精度


